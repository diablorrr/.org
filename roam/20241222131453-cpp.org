:PROPERTIES:
:ID:       8ab4df56-e11f-42b8-87f8-4daa2fd045db
:END:
#+title: cpp
#+filetags: del

* é¢„å¤„ç†ã€ç¼–è¯‘ã€é“¾æ¥
** ç¼–è¯‘
*** ç¼–è¯‘å™¨
**** gccã€g++
***** gcc
- ä¸»è¦ç”¨äºç¼–è¯‘Cç¨‹åº
- ğŸ™„ä¸ä¼šè‡ªåŠ¨é“¾æ¥C++åº“ï¼ï¼ï¼
- å°†.cæ–‡ä»¶çœ‹æˆCç¨‹åºï¼Œå°†.cppæ–‡ä»¶çœ‹æˆC++ç¨‹åº
***** g++
- å¯ä»¥ç¼–è¯‘Cç¨‹åºå’ŒC++ç¨‹åº
- ä¼šè‡ªåŠ¨é“¾æ¥C++åº“
- å°†.cå’Œ.cppæ–‡ä»¶éƒ½çœ‹æˆæ˜¯C++ç¨‹åº
***** flag
-std=c++11ï¼šæŒ‡å®šè¦ä½¿ç”¨çš„æ ‡å‡†ç‰ˆæœ¬
**** clang
***** clangd
[[id:e3917c2a-f2a1-4b42-943e-40eae4ec11ed][clangd]]æ˜¯éµå¾ª[[id:ef5b7883-d43b-4765-bdc9-daf62b50a036][lsp]]çš„åŸºäºclangçš„è¯­è¨€æœåŠ¡å™¨
** é“¾æ¥
- é™æ€åº“(Staticåº“)ï¼šç¼–è¯‘æ—¶ï¼Œé“¾æ¥å™¨å°†é™æ€åº“ä»£ç ç›´æ¥åµŒå…¥å¯æ‰§è¡Œæ–‡ä»¶ä¸­(.a .lib)
- å…±äº«åº“(Sharedåº“)ï¼šè¿è¡Œæ—¶ï¼Œç¨‹åºä¼šæŸ¥æ‰¾å¹¶åŠ è½½æ‰€éœ€çš„åŠ¨æ€åº“(.so .dll)

* è°ƒè¯•æ–¹æ³•
- [[id:8a46ff3c-7b8e-42e8-a6c9-bdaf55195c4a][gdb]] :: æ ˆä¿¡æ¯ => ä¸€å±‚ä¸€å±‚å¾€ä¸Šçœ‹
- æ—¥å¿— :: æ­»é”é—®é¢˜
- assert :: æŸ¥æ‰¾å†…å­˜æ³„æ¼é—®é¢˜
- æµ‹è¯•ç”¨ä¾‹ :: ä¾‹å¦‚å¤šçº¿ç¨‹é˜Ÿåˆ—ä¹‹ç±»çš„ä»£ç 

* C++ä¸shell
** æ–‡ä»¶ç»“æŸç¬¦
UNIXç³»ç»Ÿä¸­æ˜¯: Ctrl+D
** returnä¸é€€å‡ºçŠ¶æ€ç 
returnè¿”å›çš„å…¶å®å°±æ˜¯ é€€å‡ºçŠ¶æ€ç ï¼ˆlinuxä¸shellç¼–ç¨‹ä¸­ä¸€æ¡å‘½ä»¤çš„é€€å‡ºçŠ¶æ€ç ;èŒƒå›´0-255,è¶…å‡ºæ­¤èŒƒå›´çš„ä¼šå–æ¨¡ï¼Œ0ä»£è¡¨æˆåŠŸï¼‰
#+begin_src cpp
return 0;
return -1;
#+end_src
** ~ç¬¦å·
~ä½œä¸ºç”¨æˆ·ä¸»ç›®å½•çš„ç¼©å†™åªä¼šåœ¨shellç¯å¢ƒä¸­è§£æã€‚å› æ­¤æˆ‘ä»¬åœ¨C++ä¸­æ‰“å¼€æ–‡ä»¶åº”è¯¥ç”¨/home/ç”¨æˆ·å/...
* å­—ç¬¦ä¸²
** å­—ç¬¦ä¸²å­—é¢é‡çš„æ‹¼æ¥è§„åˆ™
åœ¨Cå’ŒC++ä¸­ï¼Œç›¸é‚»çš„å­—ç¬¦ä¸²å­—é¢é‡ä¼šè¢« è‡ªåŠ¨æ‹¼æ¥ æˆä¸€ä¸ªå®Œæ•´çš„å­—ç¬¦ä¸²
*** ç¤ºä¾‹
#+begin_src c++
const char created[] =
    "<html>"
    "<head><title>Created</title></head>"
    "<body><h1>201 Created</h1></body>"
    "</html>";
// ç­‰ä»·äº
const char created[] = "<html><head><title>Created</title></head><body><h1>201 Created</h1></body></html>";
#+end_src
* æšä¸¾ç±»å‹
- æšä¸¾å˜é‡ :: (ä¸‹æ–‡ä¸­)state_æ˜¯æšä¸¾ç±»å‹stateçš„å˜é‡ã€‚å®ƒç”¨æ¥ä¿å­˜å½“å‰çŠ¶æ€ï¼Œé€šå¸¸ä¼šåœ¨çŠ¶æ€æœºé€»è¾‘ä¸­ä¸æ–­æ›´æ–°
** è¡¨ç¤ºçŠ¶æ€æœºä¸­ç¦»æ•£çš„çŠ¶æ€
1) ç¤ºä¾‹ï¼šå¸¸ç”¨äºè¡¨ç¤ºçŠ¶æ€æœºä¸­ç¦»æ•£çš„çŠ¶æ€
#+begin_src c++
enum state
{
  method_start,
  method,
  uri,
  expecting_newline_2,
  expecting_newline_3
} state_;
#+end_src
2) ç¤ºä¾‹ï¼šä½¿ç”¨çŠ¶æ€æœº
#+begin_src c++
state_ = method_start;  // åˆå§‹çŠ¶æ€
if (some_condition) {
    state_ = uri;  // æ›´æ–°çŠ¶æ€åˆ° URI è§£æé˜¶æ®µ
}
state_ = method_start;  // è®¾ç½®åˆå§‹çŠ¶æ€
for (char c : input) {
    switch (state_) {
    case method_start:
        if (isalpha(c)) {
            state_ = method;  // è½¬æ¢åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€
        } else {
            // å¤„ç†é”™è¯¯
        }
        break;
    case method:
        if (isspace(c)) {
            state_ = uri;  // è½¬æ¢åˆ° URI è§£æé˜¶æ®µ
        }
        break;
    // å…¶ä»–çŠ¶æ€çš„å¤„ç†é€»è¾‘
    }
}
#+end_src
** æšä¸¾å€¼å’ŒæŒ‰ä½è¿ç®—ç»“åˆ
- æšä¸¾å€¼ï¼šåº•å±‚æ˜¯äºŒè¿›åˆ¶ä½è¡¨ç¤ºï¼Œä¸”è¿™äº›å€¼è¢«è®¾è®¡æˆ *äº’ä¸é‡å çš„ä½æ ‡å¿—(bit flags)*
  FlagA â†’ 0001
  FlagB â†’ 0010
  FlagC â†’ 0100
  FlagD â†’ 1000
- æŒ‰ä½æˆ–(|)ç»„åˆæ ‡å¿—ï¼š
  combined = FlagA | FlagC
  0001  (FlagA)
  0100  (FlagC)
  -------
  0101  (combined)
- æŒ‰ä½ä¸(&)æ£€æµ‹æ ‡å¿—ï¼š
  combined & FlagA
  # æ£€æŸ¥ç¬¬0ä½æ˜¯å¦ä¸º1ï¼Œå³æ˜¯å¦è®¾ç½®äº†FlagA
*** ä¸ºä»€ä¹ˆå¦‚æ­¤è®¾è®¡ï¼Ÿ
1. é«˜æ•ˆ :: æŒ‰ä½è¿ç®—éå¸¸é«˜æ•ˆ
2. ç®€æ´ :: å¤šä¸ªé€‰é¡¹å¯ä»¥ç»„åˆæˆä¸€ä¸ªå€¼
   # flags = FlagA | FlagC | FlagD

* æ§åˆ¶æµç¨‹
** forå¾ªç¯çš„å¦™ç”¨
1. whileå¾ªç¯ç”¨forå¾ªç¯ä»£æ›¿
ç¤ºä¾‹ï¼šå°†å­—ç¬¦ä¸²ä¸­æ¯ä¸ªå­—ç¬¦ç”¨Xä»£æ›¿
#+begin_src cpp
int main()
{
    string str("some string");
    decltype(str.size()) count = 0;

    for (count = 0; count < str.size(); str[count++] = 'X');
    cout << str << endl;

    return 0;
}
#+end_src
2. å¾ªç¯è¾“å‡º
#+begin_src cpp
for (int g; cin >> g; ) {
    /* */
}
#+end_src
** forå¾ªç¯å’Œwhileå¾ªç¯çš„ä¼˜ç¼ºç‚¹ï¼Ÿ
- forå¾ªç¯å†…éƒ¨å®šä¹‰äº†å±€éƒ¨å˜é‡ï¼Œwhileéœ€è¦åœ¨å¾ªç¯ä½“å¤–éƒ¨å®šä¹‰å˜é‡
- çŸ¥é“å¾ªç¯æ¬¡æ•°çš„æƒ…å†µï¼Œforå¾ªç¯å½¢å¼æ›´ç®€æ´ï¼›ä¸çŸ¥é“å¾ªç¯æ¬¡æ•°çš„æƒ…å†µï¼Œwhileå¾ªç¯æ›´ç®€æ´
** ä¸‰å…ƒè¿ç®—ç¬¦, if else
#+begin_src C++
if (i == j) {
    return true;
} else {
    return false;
}
//ç­‰ä»·å½¢å¼
i == j ? true : false;
//æ›´ç®€åŒ–çš„å½¢å¼
return i == j;
#+end_src
* è¡¨è¾¾å¼
** èµ‹å€¼è¡¨è¾¾å¼
*** èµ‹å€¼è¡¨è¾¾å¼çš„è¿”å›å€¼æ˜¯å¼•ç”¨ç±»å‹
#+begin_src cpp
int a = 3, b = 4;
decltype(a = b) d = a;
#+end_src
dçš„ç±»å‹ä¸ºint &ï¼›å€¼ä¸º3ã€‚
*** ä¸ºä»€ä¹ˆèµ‹å€¼è¡¨è¾¾å¼æœ‰è¿”å›å€¼ï¼Ÿä¸ºäº†æ”¯æŒé“¾å¼è¡¨è¾¾å¼
#+begin_src cpp
int a, b;
a = b = 1;
#+end_src
ç›¸å½“äºæ˜¯a = (b = 1)ï¼šå°†b=1çš„è¿”å›å€¼èµ‹ç»™a
*** ä¸ºä»€ä¹ˆä¸è¿”å›å€¼ï¼Œè€Œè¿”å›å¼•ç”¨ï¼Ÿä¸ºäº†æé«˜æ•ˆç‡
#+begin_src cpp
Obj a, b;
a = b = c;
#+end_src
- è‹¥éå¼•ç”¨ï¼Œåˆ™b=cçš„ç»“æœæ˜¯æ‹·è´å¤åˆ¶åˆ°è¿”å›å€¼ï¼Œå†èµ‹ç»™a
- è‹¥ä¸ºå¼•ç”¨ï¼Œåˆ™è¿”å›å€¼ç›´æ¥å¼•ç”¨b=cçš„ç»“æœ
** é€—å·è¡¨è¾¾å¼
ä»å·¦åˆ°å³æ‰§è¡Œï¼ŒæŠ›å¼ƒå·¦è¾¹çš„æ±‚å€¼ç»“æœï¼Œè¿”å›å³ä¾§è¡¨è¾¾å¼çš„å€¼
#+begin_src cpp
    i = (j++, j+100, 999+j); //içš„ç»“æœä¸º1010
    i = (j++, j+=100, 999+j); //içš„ç»“æœä¸º1110
#+end_src

* æ•°ç»„
** æ•°ç»„åˆå§‹åŒ–
- åœ¨å‡½æ•°å†…ï¼š
#+begin_src cpp
int arr[10]; //æ•°ç»„å†…çš„æ•°é»˜è®¤åˆå§‹åŒ–ä¸ºæœªå®šä¹‰çš„
int arr2[10] = {}; //æ•°ç»„å†…çš„æ•°åˆå§‹åŒ–ä¸º0
#+end_src
** Cé£æ ¼å­—ç¬¦ä¸²å’ŒCé£æ ¼æ•°ç»„
- ğŸ”¥å­—ç¬¦ä¸²å­—é¢é‡çš„æœ¬è´¨
#+begin_src C++
"hello" //æ­¤å­—ç¬¦ä¸²å­—é¢å€¼çš„æœ¬è´¨æ˜¯const char[]æˆ–è€…è¯´æ˜¯const char *
list<const char *> ls = {"hello", "world"}; //å› æ­¤è¿™é‡Œåªèƒ½ç”¨const char *ï¼Œè€Œä¸èƒ½ç”¨char *
#+end_src
- Cé£æ ¼å­—ç¬¦ä¸²çš„ä¸¤ç§ç­‰ä»·å½¢å¼
#+begin_src C++
char str[] = "hello"; //Cé£æ ¼å­—ç¬¦ä¸²ï¼Œä»¥\0ç»“å°¾
char *str = "hello"; //ç­‰ä»·å½¢å¼
{'h', 'e', 'l', 'l', 'o', '\0'} //åœ¨å†…å­˜ä¸­çš„è¡¨ç°
#+end_src
*** åŒºåˆ«
- Cé£æ ¼å­—ç¬¦ä¸²çš„é•¿åº¦æ˜¯éšå¼çš„ï¼Œç”±'\0'ç¡®å®š
- Cé£æ ¼æ•°ç»„é•¿åº¦æ˜¯æ˜¾ç¤ºå£°æ˜çš„ï¼Œç»“å°¾éå¿…é¡»æœ‰'\0'
** æŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆå¯ä»¥ç”¨ä¸‹æ ‡è¿ç®—ç¬¦è®¿é—®å…ƒç´ 
#+begin_src C++
int arr[10] = {1,2,3,4,5,6,7,8,9,0};
int *p = &arr[2];
int *p1 = arr; //ç­‰ä»·äºint *p1 = &arr[0];
cout << p[1] << endl; //4ï¼Œç­‰ä»·äº*(p+1)
cout << p1[1] << endl; //2
#+end_src
ğŸ¤®æ ¹æºåœ¨äºï¼šä¸‹æ ‡è¿ç®—ç¬¦è¿”å›çš„æ˜¯å¼•ç”¨
#+begin_src C++
int arr[10] = {1,2,3,4,5,6,7,8,9,0};
int &p = arr[3];
#+end_src
* å‡½æ•°
** lambdaçš„å¦™ç”¨
é»˜è®¤ï¼Œlambdaä½“ä¸­åŒ…å«returnä¹‹å¤–çš„ä»»ä½•è¯­å¥ï¼Œåˆ™ç¼–è¯‘å™¨é»˜è®¤lambdaè¿”å›çš„æ˜¯voidï¼›æƒ³è¦åˆ¶å®šå®ƒè¿”å›çš„ç±»å‹ï¼Œéœ€è¦å°¾ç½®è¿”å›ç±»å‹
- ç¤ºä¾‹ï¼š
#+begin_src cpp
int i = 3;
auto f = [&i](){
    if (i == 0) {
        return true;
    } else {
        return !(i--);
    }
};
while(!f()) {
    cout << i << endl;
}
#+end_src
* cppå®ç°ä¼ªé—­åŒ…æ•ˆæœ
** ä½¿ç”¨åœºæ™¯
å›è°ƒå‡½æ•°å›è°ƒæ—¶ï¼Œä¿æŒsessionä¸è¢«ææ„ï¼Œè¿™æ ·sessionæ‰èƒ½å¤„ç†å›è°ƒå‡½æ•°
** é—­åŒ…å¯¹äºå˜é‡ç”Ÿå‘½å‘¨æœŸçš„å½±å“
é—­åŒ…çš„ä¸€ç‚¹ç†è§£ï¼šå­å‡½æ•°ç”¨åˆ°äº†å¤–éƒ¨çš„å±€éƒ¨å˜é‡Aï¼Œé‚£ä¹ˆå­å‡½æ•°å†…Açš„ç”Ÿå‘½å‘¨æœŸå°±ä¼šå»¶é•¿
ç¤ºä¾‹ï¼šå­å‡½æ•°é‡Œçš„resç”Ÿå‘½å‘¨æœŸå»¶é•¿ï¼Œä¿æŒå’Œå¤–éƒ¨å‡½æ•°DeferReturn()åŒæ­¥
#+begin_src go
func DeferReturn() (res int){
    defer func() {
         res++
         log.Println(res)
    }()
    return 0
}
#+end_src
** cppä¸­çš„å®ç°
1. åˆ©ç”¨æ™ºèƒ½æŒ‡é’ˆè¢«å¤åˆ¶æˆ–ä½¿ç”¨å¼•ç”¨è®¡æ•°åŠ ä¸€çš„åŸç†ä¿è¯å†…å­˜ä¸è¢«å›æ”¶
2. bindæ“ä½œå¯å°†å€¼ç»‘å®šåœ¨ä¸€ä¸ªå‡½æ•°å¯¹è±¡ä¸Šç”Ÿæˆæ–°çš„å‡½æ•°å¯¹è±¡ã€‚è‹¥æ™ºèƒ½æŒ‡é’ˆä»¥å€¼ä¼ é€’çš„æ–¹å¼ç»‘å®šåˆ°å‡½æ•°å¯¹è±¡ï¼Œé‚£ä¹ˆæ™ºèƒ½æŒ‡é’ˆçš„ç”Ÿå‘½å‘¨æœŸå°†å’Œæ–°ç”Ÿæˆçš„å‡½æ•°å¯¹è±¡ä¸€è‡´
   #+begin_src c++
   void CSession::HandleWrite(const boost::system::error_code& error, shared_ptr<CSession> _self_shared) {
    if (!error) {
        std::lock_guard<std::mutex> lock(_send_lock);
        _send_que.pop();
        if (!_send_que.empty()) {
            auto &msgnode = _send_que.front();
            boost::asio::async_write(_socket, boost::asio::buffer(msgnode->_data, msgnode->_max_len),
                std::bind(&CSession::HandleWrite, this, std::placeholders::_1, _self_shared));
        }
    }
    else {
        std::cout << "handle write failed, error is " << error.what() << endl;
        _server->ClearSession(_uuid);
    }
  }
   #+end_src
  ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œ_self_sharedçš„ç”Ÿå‘½å‘¨æœŸä¸bindæ–°ç”Ÿæˆçš„å‡½æ•°(å›è°ƒå‡½æ•°)ä¿æŒä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯CSessionå’Œå›è°ƒå‡½æ•°ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´
** ä½¿ç”¨ä¼ªé—­åŒ…çš„æ³¨æ„äº‹é¡¹
# Sessionå’Œå›è°ƒå‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´ => è·å–Sessionçš„æŒ‡é’ˆ => è¯¥æŒ‡é’ˆåœ¨Sessionå†…éƒ¨ä½¿ç”¨ => ä¸èƒ½ä½¿ç”¨ä¸¤ä¸ªæ™ºèƒ½æŒ‡é’ˆå…±åŒç®¡ç†Session => å¼•ç”¨è®¡æ•°ä¸åŒæ­¥
- é”™è¯¯ç¤ºä¾‹ ::
  shared_ptr<CSession>(this)ç”Ÿæˆäº†æ–°çš„æ™ºèƒ½æŒ‡é’ˆï¼Œä¸å…¶ä»–ç®¡ç†thisçš„æ™ºèƒ½æŒ‡é’ˆå¼•ç”¨è®¡æ•°ä¸åŒæ­¥
  #+begin_src c++
  void CSession::Start(){
      memset(_data, 0, MAX_LENGTH);
      _socket.async_read_some(boost::asio::buffer(_data, MAX_LENGTH), std::bind(&CSession::HandleRead, this,
          std::placeholders::_1, std::placeholders::_2, shared_ptr<CSession>(this)));
  }
  #+end_src
- æ­£ç¡®ç¤ºä¾‹ ::
  ä½¿ç”¨enable_shared_from_thiså’Œshared_from_this()å…±äº«ä¸å…¶ä»–åŸºäºthisçš„æ™ºèƒ½æŒ‡é’ˆçš„å¼•ç”¨è®¡æ•°
  #+begin_src c++
  void CSession::Start(){
      memset(_data, 0, MAX_LENGTH);
      _socket.async_read_some(boost::asio::buffer(_data, MAX_LENGTH), std::bind(&CSession::HandleRead, this,
          std::placeholders::_1, std::placeholders::_2, shared_from_this()));
  }
  #+end_src
