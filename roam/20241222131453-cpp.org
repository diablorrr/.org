:PROPERTIES:
:ID:       8ab4df56-e11f-42b8-87f8-4daa2fd045db
:END:
#+title: cpp
#+filetags: cpp del

* è°ƒè¯•æ–¹æ³•
- [[id:8a46ff3c-7b8e-42e8-a6c9-bdaf55195c4a][gdb]] :: æ ˆä¿¡æ¯ => ä¸€å±‚ä¸€å±‚å¾€ä¸Šçœ‹
- æ—¥å¿— :: æ­»é”é—®é¢˜
- assert :: æŸ¥æ‰¾å†…å­˜æ³„æ¼é—®é¢˜
- æµ‹è¯•ç”¨ä¾‹ :: ä¾‹å¦‚å¤šçº¿ç¨‹é˜Ÿåˆ—ä¹‹ç±»çš„ä»£ç 

* C++ä¸shell
** æ–‡ä»¶ç»“æŸç¬¦
UNIXç³»ç»Ÿä¸­æ˜¯: Ctrl+D
** returnä¸é€€å‡ºçŠ¶æ€ç 
returnè¿”å›çš„å…¶å®å°±æ˜¯ é€€å‡ºçŠ¶æ€ç ï¼ˆlinuxä¸shellç¼–ç¨‹ä¸­ä¸€æ¡å‘½ä»¤çš„é€€å‡ºçŠ¶æ€ç ;èŒƒå›´0-255,è¶…å‡ºæ­¤èŒƒå›´çš„ä¼šå–æ¨¡ï¼Œ0ä»£è¡¨æˆåŠŸï¼‰
#+begin_src cpp
return 0;
return -1;
#+end_src
** ~ç¬¦å·
~ä½œä¸ºç”¨æˆ·ä¸»ç›®å½•çš„ç¼©å†™åªä¼šåœ¨shellç¯å¢ƒä¸­è§£æã€‚å› æ­¤æˆ‘ä»¬åœ¨C++ä¸­æ‰“å¼€æ–‡ä»¶åº”è¯¥ç”¨/home/ç”¨æˆ·å/...
* å­—ç¬¦ä¸²
** å­—ç¬¦ä¸²å­—é¢é‡çš„æ‹¼æ¥è§„åˆ™
åœ¨Cå’ŒC++ä¸­ï¼Œç›¸é‚»çš„å­—ç¬¦ä¸²å­—é¢é‡ä¼šè¢« è‡ªåŠ¨æ‹¼æ¥ æˆä¸€ä¸ªå®Œæ•´çš„å­—ç¬¦ä¸²
*** ç¤ºä¾‹
#+begin_src c++
const char created[] =
    "<html>"
    "<head><title>Created</title></head>"
    "<body><h1>201 Created</h1></body>"
    "</html>";
// ç­‰ä»·äº
const char created[] = "<html><head><title>Created</title></head><body><h1>201 Created</h1></body></html>";
#+end_src

* è¡¨è¾¾å¼
** èµ‹å€¼è¡¨è¾¾å¼
*** èµ‹å€¼è¡¨è¾¾å¼çš„è¿”å›å€¼æ˜¯å¼•ç”¨ç±»å‹
#+begin_src cpp
int a = 3, b = 4;
decltype(a = b) d = a;
#+end_src
dçš„ç±»å‹ä¸ºint &ï¼›å€¼ä¸º3ã€‚
*** ä¸ºä»€ä¹ˆèµ‹å€¼è¡¨è¾¾å¼æœ‰è¿”å›å€¼ï¼Ÿä¸ºäº†æ”¯æŒé“¾å¼è¡¨è¾¾å¼
#+begin_src cpp
int a, b;
a = b = 1;
#+end_src
ç›¸å½“äºæ˜¯a = (b = 1)ï¼šå°†b=1çš„è¿”å›å€¼èµ‹ç»™a
*** ä¸ºä»€ä¹ˆä¸è¿”å›å€¼ï¼Œè€Œè¿”å›å¼•ç”¨ï¼Ÿä¸ºäº†æé«˜æ•ˆç‡
#+begin_src cpp
Obj a, b;
a = b = c;
#+end_src
- è‹¥éå¼•ç”¨ï¼Œåˆ™b=cçš„ç»“æœæ˜¯æ‹·è´å¤åˆ¶åˆ°è¿”å›å€¼ï¼Œå†èµ‹ç»™a
- è‹¥ä¸ºå¼•ç”¨ï¼Œåˆ™è¿”å›å€¼ç›´æ¥å¼•ç”¨b=cçš„ç»“æœ

* æ•°ç»„
** Cé£æ ¼å­—ç¬¦ä¸²å’ŒCé£æ ¼æ•°ç»„
- ğŸ”¥å­—ç¬¦ä¸²å­—é¢é‡çš„æœ¬è´¨
#+begin_src C++
"hello" //æ­¤å­—ç¬¦ä¸²å­—é¢å€¼çš„æœ¬è´¨æ˜¯const char[]æˆ–è€…è¯´æ˜¯const char *
list<const char *> ls = {"hello", "world"}; //å› æ­¤è¿™é‡Œåªèƒ½ç”¨const char *ï¼Œè€Œä¸èƒ½ç”¨char *
#+end_src
- Cé£æ ¼å­—ç¬¦ä¸²çš„ä¸¤ç§ç­‰ä»·å½¢å¼
#+begin_src C++
char str[] = "hello"; //Cé£æ ¼å­—ç¬¦ä¸²ï¼Œä»¥\0ç»“å°¾
char *str = "hello"; //ç­‰ä»·å½¢å¼
{'h', 'e', 'l', 'l', 'o', '\0'} //åœ¨å†…å­˜ä¸­çš„è¡¨ç°
#+end_src
*** åŒºåˆ«
- Cé£æ ¼å­—ç¬¦ä¸²çš„é•¿åº¦æ˜¯éšå¼çš„ï¼Œç”±'\0'ç¡®å®š
- Cé£æ ¼æ•°ç»„é•¿åº¦æ˜¯æ˜¾ç¤ºå£°æ˜çš„ï¼Œç»“å°¾éå¿…é¡»æœ‰'\0'
** æŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆå¯ä»¥ç”¨ä¸‹æ ‡è¿ç®—ç¬¦è®¿é—®å…ƒç´ 
#+begin_src C++
int arr[10] = {1,2,3,4,5,6,7,8,9,0};
int *p = &arr[2];
int *p1 = arr; //ç­‰ä»·äºint *p1 = &arr[0];
cout << p[1] << endl; //4ï¼Œç­‰ä»·äº*(p+1)
cout << p1[1] << endl; //2
#+end_src
ğŸ¤®æ ¹æºåœ¨äºï¼šä¸‹æ ‡è¿ç®—ç¬¦è¿”å›çš„æ˜¯å¼•ç”¨
#+begin_src C++
int arr[10] = {1,2,3,4,5,6,7,8,9,0};
int &p = arr[3];
#+end_src

* cppå®ç°ä¼ªé—­åŒ…æ•ˆæœ
** ä½¿ç”¨åœºæ™¯
å›è°ƒå‡½æ•°å›è°ƒæ—¶ï¼Œä¿æŒsessionä¸è¢«ææ„ï¼Œè¿™æ ·sessionæ‰èƒ½å¤„ç†å›è°ƒå‡½æ•°
** é—­åŒ…å¯¹äºå˜é‡ç”Ÿå‘½å‘¨æœŸçš„å½±å“
é—­åŒ…çš„ä¸€ç‚¹ç†è§£ï¼šå­å‡½æ•°ç”¨åˆ°äº†å¤–éƒ¨çš„å±€éƒ¨å˜é‡Aï¼Œé‚£ä¹ˆå­å‡½æ•°å†…Açš„ç”Ÿå‘½å‘¨æœŸå°±ä¼šå»¶é•¿
ç¤ºä¾‹ï¼šå­å‡½æ•°é‡Œçš„resç”Ÿå‘½å‘¨æœŸå»¶é•¿ï¼Œä¿æŒå’Œå¤–éƒ¨å‡½æ•°DeferReturn()åŒæ­¥
#+begin_src go
func DeferReturn() (res int){
    defer func() {
         res++
         log.Println(res)
    }()
    return 0
}
#+end_src
** cppä¸­çš„å®ç°
1. åˆ©ç”¨æ™ºèƒ½æŒ‡é’ˆè¢«å¤åˆ¶æˆ–ä½¿ç”¨å¼•ç”¨è®¡æ•°åŠ ä¸€çš„åŸç†ä¿è¯å†…å­˜ä¸è¢«å›æ”¶
2. bindæ“ä½œå¯å°†å€¼ç»‘å®šåœ¨ä¸€ä¸ªå‡½æ•°å¯¹è±¡ä¸Šç”Ÿæˆæ–°çš„å‡½æ•°å¯¹è±¡ã€‚è‹¥æ™ºèƒ½æŒ‡é’ˆä»¥å€¼ä¼ é€’çš„æ–¹å¼ç»‘å®šåˆ°å‡½æ•°å¯¹è±¡ï¼Œé‚£ä¹ˆæ™ºèƒ½æŒ‡é’ˆçš„ç”Ÿå‘½å‘¨æœŸå°†å’Œæ–°ç”Ÿæˆçš„å‡½æ•°å¯¹è±¡ä¸€è‡´
   #+begin_src c++
   void CSession::HandleWrite(const boost::system::error_code& error, shared_ptr<CSession> _self_shared) {
    if (!error) {
        std::lock_guard<std::mutex> lock(_send_lock);
        _send_que.pop();
        if (!_send_que.empty()) {
            auto &msgnode = _send_que.front();
            boost::asio::async_write(_socket, boost::asio::buffer(msgnode->_data, msgnode->_max_len),
                std::bind(&CSession::HandleWrite, this, std::placeholders::_1, _self_shared));
        }
    }
    else {
        std::cout << "handle write failed, error is " << error.what() << endl;
        _server->ClearSession(_uuid);
    }
  }
   #+end_src
  ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œ_self_sharedçš„ç”Ÿå‘½å‘¨æœŸä¸bindæ–°ç”Ÿæˆçš„å‡½æ•°(å›è°ƒå‡½æ•°)ä¿æŒä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯CSessionå’Œå›è°ƒå‡½æ•°ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´
** ä½¿ç”¨ä¼ªé—­åŒ…çš„æ³¨æ„äº‹é¡¹
# Sessionå’Œå›è°ƒå‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´ => è·å–Sessionçš„æŒ‡é’ˆ => è¯¥æŒ‡é’ˆåœ¨Sessionå†…éƒ¨ä½¿ç”¨ => ä¸èƒ½ä½¿ç”¨ä¸¤ä¸ªæ™ºèƒ½æŒ‡é’ˆå…±åŒç®¡ç†Session => å¼•ç”¨è®¡æ•°ä¸åŒæ­¥
- é”™è¯¯ç¤ºä¾‹ ::
  shared_ptr<CSession>(this)ç”Ÿæˆäº†æ–°çš„æ™ºèƒ½æŒ‡é’ˆï¼Œä¸å…¶ä»–ç®¡ç†thisçš„æ™ºèƒ½æŒ‡é’ˆå¼•ç”¨è®¡æ•°ä¸åŒæ­¥
  #+begin_src c++
  void CSession::Start(){
      memset(_data, 0, MAX_LENGTH);
      _socket.async_read_some(boost::asio::buffer(_data, MAX_LENGTH), std::bind(&CSession::HandleRead, this,
          std::placeholders::_1, std::placeholders::_2, shared_ptr<CSession>(this)));
  }
  #+end_src
- æ­£ç¡®ç¤ºä¾‹ ::
  ä½¿ç”¨enable_shared_from_thiså’Œshared_from_this()å…±äº«ä¸å…¶ä»–åŸºäºthisçš„æ™ºèƒ½æŒ‡é’ˆçš„å¼•ç”¨è®¡æ•°
  #+begin_src c++
  void CSession::Start(){
      memset(_data, 0, MAX_LENGTH);
      _socket.async_read_some(boost::asio::buffer(_data, MAX_LENGTH), std::bind(&CSession::HandleRead, this,
          std::placeholders::_1, std::placeholders::_2, shared_from_this()));
  }
  #+end_src
