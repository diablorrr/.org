:PROPERTIES:
:ID:       183c9f25-d3a3-4a95-baa1-5e1a3b201a11
:END:
#+title: CMakeLists.txt
#+STARTUP show2levels



* ä½¿ç”¨
** è®¾ç½®cpp17æ ‡å‡†æ™ºèƒ½æ„ŸçŸ¥
1. CMakeLists.txtç¼–å†™å¦‚ä¸‹
   #+begin_src cmake
   cmake_minimum_required(VERSION 3.10)
   project(MyProject CXX)

   set(CMAKE_CXX_STANDARD 17)  # è®¾ç½® C++17 æ ‡å‡†
   set(CMAKE_CXX_STANDARD_REQUIRED ON)  # å¼ºåˆ¶ä½¿ç”¨ C++17ï¼Œä¸å…è®¸é™çº§
   set(CMAKE_CXX_EXTENSIONS OFF)  # ä½¿ç”¨çº¯ C++17 æ ‡å‡†ï¼Œä¸ä½¿ç”¨ç¼–è¯‘å™¨æ‰©å±•
   set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

   add_executable(myapp main.cpp)
   target_compile_features(myapp PRIVATE cxx_std_17)  # ä¸º myapp å¯ç”¨ C++17
   #+end_src
2. mkdir build && cd build
3. cmake ..
4. cmake --build .

** æ²¡æœ‰[[id:c4819291-b93f-4864-b210-aa436634ac22][.cmake]]é…ç½®æ–‡ä»¶çš„package
- åšæ³• :: æˆ‘ä»¬ä¼šå…ˆåŒ…å«åº“æ–‡ä»¶ç›®å½•ï¼Œå°†ç›®å½•é‡Œæˆ‘ä»¬éœ€è¦çš„æ–‡ä»¶å­˜åˆ°ä¸€ä¸ªå˜é‡é‡Œï¼Œç„¶åç›®æ ‡å†å»é“¾æ¥
- ç¤ºä¾‹ ::
#+begin_src cmake
include_directories(/usr/lib)
file(GLOB absl_libs "/usr/lib/libabsl_*.so")
target_link_libraries(main ${absl_libs})
#+end_src


* æŸ¥è¯¢
** æœ¯è¯­
- ç›®æ ‡ :: å¯æ‰§è¡Œæ–‡ä»¶ã€åº“
** è¯­æ³•
:PROPERTIES:
:VISIBILITY: show2levels
:END:
*** cmake_minimum_required :: è®¾ç½®æœ€ä½[[id:c651b8b0-bc76-451d-acac-0ea55329f0e8][cmake]]ç‰ˆæœ¬
*** project :: å®šä¹‰é¡¹ç›®åç§°
*** set :: å®šä¹‰ã€ä¿®æ”¹å˜é‡
 - è®¾ç½®cppæ ‡å‡† ::
   #+begin_src cmake
   set(CMAKE_CXX_STANDARD 17)
   set(CMAKE_CXX_STANDARD_REQUIRED ON)
   #+end_src
 - è®¾ç½®cppç¼–è¯‘é€‰é¡¹ ::
   #+begin_src cmake
   set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -g")
   #+end_src

*** file :: å¤„ç†æ–‡ä»¶ç³»ç»Ÿç›¸å…³æ“ä½œ
 - è·å–æ–‡ä»¶åˆ—è¡¨ ::
   #+begin_src cmake
   file(GLOB <variable> [RELATIVE <path>] <glob_pattern>...)
   file(GLOB_RECURSE <variable> [RELATIVE <path>] <glob_pattern>...)
   #+end_src
   + GLOB :: glob(é€šé…ç¬¦åŒ¹é…çš„æ„æ€)çš„æ–‡ä»¶(ä¸é€’å½’å­ç›®å½•)
   + GLOB_RECURSE :: é€’å½’è·å–å­ç›®å½•ä¸­çš„ç¬¦åˆæ¨¡å¼çš„æ–‡ä»¶
   + <variable> :: å­˜å‚¨åŒ¹é…æ–‡ä»¶è·¯å¾„çš„å˜é‡
   + <glob_pattern> :: é€šé…ç¬¦æ¨¡å¼ï¼Œé€šå¸¸æ˜¯æ–‡ä»¶æ‰©å±•åï¼Œå¦‚ *.cppã€*.h

*** add_executable :: æ·»åŠ å¯æ‰§è¡Œæ–‡ä»¶
*** target_include_directories :: å¤´æ–‡ä»¶æœç´¢è·¯å¾„
  #+begin_src cmake
  target_include_directories(<target> <INTERFACE|PUBLIC|PRIVATE> [<directory>...])
  #+end_src

*** target_link_libraries :: é“¾æ¥é™æ€/åŠ¨æ€åº“
  #+begin_src cmake
  target_link_libraries(<target> <INTERFACE|PUBLIC|PRIVATE> <library>...)
  #+end_src
*** install :: æŒ‡å®šæ–‡ä»¶å¤åˆ¶åˆ°å“ªä¸ªæ–‡ä»¶å¤¹
#+begin_src cmake
install(TARGETS target1 target2 ...
        [EXPORT <export-name>]
        [RUNTIME DESTINATION <dir>] # å¯æ‰§è¡Œæ–‡ä»¶
        [LIBRARY DESTINATION <dir>] # åŠ¨æ€åº“
        [ARCHIVE DESTINATION <dir>] # é™æ€åº“
        [INCLUDES DESTINATION <dir>]
        [OPTIONAL])
#+end_src
- å®‰è£…è·¯å¾„ :: CMAKE_INSTALL_PREFIX æ§åˆ¶ï¼Œé»˜è®¤æ˜¯ /usr/local
- ğŸ‚æ³¨æ„ :: install(...)çš„ä»£ç ï¼Œåªæœ‰åœ¨cmake --install .åæ‰ä¼šæ‰§è¡Œ
**** ç¤ºä¾‹
#+begin_src cmake
add_executable(myapp main.cpp)
install(TARGETS myapp DESTINATION bin)
#+end_src
- å®‰è£…åˆ°ï¼š${CMAKE_INSTALL_PREFIX}/bin/myapp
*** add_library :: åˆ›å»ºä¸€ä¸ªåº“(åŠ¨æ€åº“ã€é™æ€åº“)
*** set_target_properties :: è®¾ç½®ç›®æ ‡çš„å±æ€§
#+begin_src cmake
set_target_properties(<target> PROPERTIES <prop1> <value1> [<prop2> <value2> ...])
#+end_src
**** ç¤ºä¾‹
***** è®¾ç½®è¿è¡Œæ—¶æŸ¥æ‰¾åº“è·¯å¾„
#+begin_src cmake
# å‘Šè¯‰cmakeï¼Œåœ¨è¿è¡Œæ—¶å»$ORIGIN/../libæ‰¾åŠ¨æ€åº“
set_target_properties(MyApp PROPERTIES
  BUILD_WITH_INSTALL_RPATH TRUE
  INSTALL_RPATH "$ORIGIN/../lib"
)
#+end_src
- $ORIGIN :: è¡¨ç¤ºå½“å‰æ‰§è¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶çš„ç›®å½•
*** ExternalProject_Add :: æ„å»ºå¤–éƒ¨é¡¹ç›®(å­é¡¹ç›®)
#+begin_src cmake
ExternalProject_Add(<name>
    [URL <url> | SOURCE_DIR <path>] # ç½‘ç»œæºç  | æœ¬åœ°æºç 
    [BINARY_DIR <path>]             # ç¼–è¯‘ç›®å½•ï¼šé»˜è®¤${name}-build
    [INSTALL_DIR <path>]            # å®‰è£…è·¯å¾„
    [CMAKE_ARGS <arg1> <arg2> ...]  # ä¼ ç»™å¤–éƒ¨é¡¹ç›®çš„cmakeå‚æ•°
    [BUILD_COMMAND <cmd>]           # è‡ªå®šä¹‰æ„å»ºå‘½ä»¤
    [INSTALL_COMMAND <cmd>]         # è‡ªå®šä¹‰å®‰è£…å‘½ä»¤
    [LOG_CONFIGURE 1]
    [LOG_BUILD 1]
    [LOG_INSTALL 1]
    ...
)

#+end_src
- ä»€ä¹ˆæ—¶å€™è¿è¡Œ :: æ„å»ºä¸»é¡¹ç›®æ—¶ï¼Œcmakeä¼š
  1. æ„å»ºå­é¡¹ç›®
  2. å®‰è£…å­é¡¹ç›®
*** add_subdirectory :: åœ¨ä¸»CMakeLists.txtä¸­æ·»åŠ å­ç›®å½•
*** add_custom_command :: æ„å»ºè¿‡ç¨‹ä¸­æ·»åŠ è‡ªå®šä¹‰çš„å‘½ä»¤
ä»…å®šä¹‰add_custom_command()æ˜¯ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œçš„ï¼Œå¿…é¡»æœ‰targetä½¿ç”¨å®ƒçš„è¾“å‡º
- ä»¥ä¸‹ç¤ºä¾‹ä¸­çš„proto_srcså’Œgrpc_srcséƒ½æ˜¯add_custom_command()çš„è¾“å‡º
  1. ç¤ºä¾‹1
   #+begin_src cmake
   add_executable(my_app main.cpp ${proto_srcs} ${grpc_srcs})
   #+end_src
  2. ç¤ºä¾‹2
   #+begin_src cmake
   add_library(proto_files
     ${proto_srcs}
     ${grpc_srcs}
   )
   #+end_src
  3. ç¤ºä¾‹3
   #+begin_src cmake
   add_dependencies(proto_files
     ${proto_srcs} ${grpc_srcs}
   )
   #+end_src

*** [[id:2e20f81d-56f0-4af5-a00c-b77fce675287][find_package()]] ::
  #+begin_src cmake
  find_package(<package> [version] [EXACT] [QUIET] [REQUIRED] [CONFIG|NO_MODULE] [MODULE])
  #+end_src
  + <package> :: åŒ…çš„åç§°
  + [REQUIRED] :: åŒ…æœªæ‰¾åˆ°ï¼ŒCMakeä¼šåœæ­¢å¹¶æŠ¥é”™
  + [CONFIG] :: æŸ¥æ‰¾ <Package>Config.cmake
  + [MODULE] :: æŸ¥æ‰¾ Find<Package>.cmake
  + [version] :: åŒ…çš„ç‰ˆæœ¬è¦æ±‚ï¼ˆå¯é€‰ï¼‰
  + [EXACT] :: è¦æ±‚ç²¾ç¡®åŒ¹é…æŒ‡å®šçš„ç‰ˆæœ¬
  + [QUIET] :: ä¸ä¼šæ˜¾ç¤ºæ‰¾ä¸åˆ°åŒ…çš„è­¦å‘Šä¿¡æ¯ã€‚å³ä½¿åŒ…æœªæ‰¾åˆ°ï¼ŒCMakeä¹Ÿä¸ä¼šå‘å‡ºè­¦å‘Š
*** pkg_check_modules :: ä½¿ç”¨[[id:0867edf9-0f48-48ed-92be-e197f1546b05][pkg-config]]æŸ¥æ‰¾åº“
#+begin_src cmake
pkg_check_modules(<prefix> [REQUIRED] <package> [<version>])
#+end_src
- <prefix> :: æŒ‡å®šä¸€ä¸ªå‰ç¼€ï¼ŒCMake å°†ä½¿ç”¨è¿™ä¸ªå‰ç¼€ä¸ºåº“çš„ç›¸å…³å˜é‡å‘½åã€‚é€šå¸¸æ˜¯å¤§å†™çš„åº“åç§°ï¼Œå¦‚ HIREDISã€‚
- [REQUIRED] :: å¦‚æœæ‰¾ä¸åˆ°æŒ‡å®šçš„åº“ï¼ŒCMakeä¼šæŠ¥é”™å¹¶åœæ­¢æ„å»º
- <package> :: åº“çš„åç§°ï¼Œå’Œ pkg-config çš„ .pc æ–‡ä»¶åç›¸åŒ
- [<version>] :: æŒ‡å®šåº“ç‰ˆæœ¬

- ç¤ºä¾‹ :: prefixè®¾ç½®ä¸ºHIREDIS => æ‰€ä»¥hiredisçš„å¤´æ–‡ä»¶ç›®å½•ä¸ºHIREDIS_INCLUDE_DIRSã€åº“æ–‡ä»¶è·¯å¾„å˜ä¸ºHIREDIS_LIBRARIES
#+begin_src cmake
find_package(PkgConfig REQUIRED)
pkg_check_modules(HIREDIS REQUIRED hiredis)
...
target_include_directories(test_redis PRIVATE ${HIREDIS_INCLUDE_DIRS})
target_link_libraries(test_redis PRIVATE ${HIREDIS_LIBRARIES})
#+end_src
*** message :: è¾“å‡ºæ¶ˆæ¯åˆ°æ§åˆ¶å°
  #+begin_src cmake
  message([<mode>] "message" ...)
  #+end_src
 - <mode> :: æŒ‡å®šæ¶ˆæ¯çš„ç±»å‹
   + STATUS :: è¾“å‡ºæ­£å¸¸çŠ¶æ€æ¶ˆæ¯

*** <INTERFACE|PUBLIC|PRIVATE>å…³é”®å­—
- ä½œç”¨ :: æ§åˆ¶å¯¹ç›®æ ‡çš„å¯è§æ€§
  + PRIVATE :: ä»…å¯¹å½“å‰ç›®æ ‡å¯è§ï¼Œä¸ä¼šä¼ é€’ç»™é“¾æ¥åˆ°æ­¤ç›®æ ‡çš„å…¶ä»–ç›®æ ‡
  + PUBLIC :: ä¸ä»…å¯¹å½“å‰ç›®æ ‡å¯è§ï¼Œè¿˜ä¼šä¼ é€’ç»™é“¾æ¥åˆ°æ­¤ç›®æ ‡çš„å…¶ä»–ç›®æ ‡
  + INTERFACE :: å¯¹å½“å‰ç›®æ ‡ä¸å¯è§ï¼Œåªä¼šä¼ é€’ç»™é“¾æ¥åˆ°æ­¤ç›®æ ‡çš„å…¶ä»–ç›®æ ‡
*** é¢„å®šä¹‰å˜é‡
- CMAKE_CURRENT_SOURCE_DIR :: å½“å‰CMakeLists.txtæ–‡ä»¶æ‰€åœ¨çš„ç›®å½•
- CMAKE_CXX_STANDARD :: è®¾ç½®cppæ ‡å‡†
- CMAKE_CXX_STANDARD_REQUIRED :: å¼ºåˆ¶ç¼–è¯‘å™¨ä½¿ç”¨æ ‡å‡†


* æ¦‚å¿µ
- ç®€ä»‹ ::
  1. æ˜¯ [[id:c651b8b0-bc76-451d-acac-0ea55329f0e8][cmake]] çš„é…ç½®æ–‡ä»¶
  2. ç”¨äºå®šä¹‰å¦‚ä½•æ„å»º c/[[id:8ab4df56-e11f-42b8-87f8-4daa2fd045db][cpp]] é¡¹ç›®
  3. [[id:c651b8b0-bc76-451d-acac-0ea55329f0e8][cmake]] é€šè¿‡è§£æ CMakeLists.txt ç”Ÿæˆ Makefileã€Ninja æ–‡ä»¶æˆ– Visual Studio é¡¹ç›®ï¼Œé€‚é…ä¸åŒçš„æ„å»ºç³»ç»Ÿ
