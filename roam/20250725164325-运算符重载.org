:PROPERTIES:
:ID:       d39c4157-a6d7-430c-84aa-741878eaa828
:END:
#+title: è¿ç®—ç¬¦é‡è½½
#+filetags: cpp

* è¿ç®—ç¬¦é‡è½½ [[https://www.learncpp.com/cpp-tutorial/introduction-to-operator-overloading/][learncpp21.1]] [[https://www.learncpp.com/cpp-tutorial/overloading-the-io-operators/][learncpp21.4]] [[https://www.learncpp.com/cpp-tutorial/overloading-operators-using-member-functions/][learncpp21.5]]
è¿ç®—ç¬¦æ˜¯ *ç”±å‡½æ•°å®ç°* çš„ï¼Œç±»ä¼¼ å‡½æ•°æœ‰ [[id:6c92dc3d-9ce0-4d40-9597-5ecc93ea3366][å‡½æ•°é‡è½½]]ï¼Œè¿ç®—ç¬¦æœ‰è¿ç®—ç¬¦é‡è½½

1. ç¼–è¯‘å™¨ *è§£æè¿ç®—ç¬¦è§„åˆ™*
   1) æ“ä½œæ•° æ˜¯ åŸºæœ¬ç±»å‹    ï¼šä½¿ç”¨ å†…ç½®è§„åˆ™
   2) æ“ä½œæ•° æ˜¯ [[id:f1619246-a266-4149-a059-021406106873][ç¨‹åºå®šä¹‰ç±»å‹]]ï¼šä½¿ç”¨ [[id:8c55eec4-57bb-45c2-8890-c65d7c473a24][å‡½æ•°é‡è½½è§£æ]]

2. *é‡è½½è¿ç®—ç¬¦çš„æ–¹æ³•*
   - æˆå‘˜å‡½æ•° :: å·¦æ“ä½œæ•° æ˜¯éšå¼çš„ =*this= å¯¹è±¡ [fn:4]
   - éæˆå‘˜å‡½æ•° ::
     + æ™®é€šå‡½æ•° :: ä½¿ç”¨ç±»æä¾›çš„å…¬å…±æ¥å£è®¿é—®ç§æœ‰æˆå‘˜[fn:2]ï¼Œä¸å‹å…ƒçš„åŒºåˆ«ï¼šåˆ†æ–‡ä»¶ç¼–å†™æ—¶éœ€è¦æä¾›å‡½æ•°å£°æ˜[fn:3] [[https://www.learncpp.com/cpp-tutorial/overloading-operators-using-normal-functions/][learncpp21.3]]
     + å‹å‘˜å‡½æ•° :: å¯ä»¥åœ¨ç±»å†…/å¤–å®šä¹‰ [fn:1] [[https://www.learncpp.com/cpp-tutorial/overloading-the-arithmetic-operators-using-friend-functions/][learncpp21.2]]

   *æ–¹æ³•é€‰æ‹©*
   - æˆå‘˜å‡½æ•° ::
     a. [ *å¿…é¡»* ] èµ‹å€¼ã€ä¸‹æ ‡ã€å‡½æ•°è°ƒç”¨ã€æˆå‘˜é€‰æ‹©ï¼š === ï¼Œ =[]= ï¼Œ =()= ï¼Œ =->=
     b. æ”¹å˜å¯¹è±¡çŠ¶æ€çš„ï¼š =+== ï¼Œ =-== ï¼Œ =++= ï¼Œ =--=
   - éæˆå‘˜å‡½æ•° ::
     a. [ *å¿…é¡»* ] å·¦æ“ä½œæ•°æ˜¯æµå¯¹è±¡ï¼š =<<= ï¼Œ =>>= [fn:5]
     b. å¯¹ç§°æ€§ï¼Œæ”¯æŒéšå¼ç±»å‹è£…æ¢ï¼š =+= ï¼Œ =-= ï¼Œ ==== ï¼Œ =!==

3. æ“ä½œæ•°é¡ºåºä¸åŒ æˆ– æ“ä½œç¬¦ä¹‹é—´æœ‰å…³è”ï¼Œå¯ä»¥ä½¿ç”¨ *å·²å®ç°çš„è¿ç®—ç¬¦æ¥å®ç°*
   #+begin_src cpp :results output :namespaces std :includes <iostream>
   // å‚æ•°é¡ºåºä¸åŒ
   Cents operator+(const Cents& c1, int value);
   Cents operator+(int value, const Cents& c1) { return c1 + value; } // è°ƒç”¨ operator+(const Cents& c1, int value);

   // æ“ä½œç¬¦ä¹‹é—´æœ‰å…³è”
   bool operator== (const Cents& c1, const Cents& c2) { return c1.m_cents == c2.m_cents; }
   bool operator!= (const Cents& c1, const Cents& c2) { return !(operator==(c1, c2)); }
   bool operator< (const Cents& c1, const Cents& c2) { return c1.m_cents < c2.m_cents; }
   bool operator> (const Cents& c1, const Cents& c2) { return operator<(c2, c1); }
   bool operator<= (const Cents& c1, const Cents& c2) { return !(operator>(c1, c2)); }
   bool operator>= (const Cents& c1, const Cents& c2) { return !(operator<(c1, c2)); }
   #+end_src

4. *ä½¿ç”¨é™åˆ¶*
   1) ğŸ”¥ é‡è½½è¿ç®—ç¬¦ä¸­ *è‡³å°‘ä¸€ä¸ªæ“ä½œæ•°æ˜¯ [[id:f1619246-a266-4149-a059-021406106873][ç”¨æˆ·å®šä¹‰ç±»å‹]]*
      #+begin_src cpp :results output :namespaces std :includes <iostream>
      operator+(int, Mystring) // ok
      operator+(int, double)   // FIXME
      #+end_src
   2) åªèƒ½é‡è½½ *å·²æœ‰è¿ç®—ç¬¦* ï¼›è¿ç®—ç¬¦ *æ“ä½œæ•°æ•°é‡* æ— æ³•æ”¹å˜ ï¼›è¿ç®—ç¬¦ä¿æŒ *é»˜è®¤ä¼˜å…ˆçº§å’Œç»“åˆæ€§*
   3) ä»¥ä¸‹è¿ç®—ç¬¦ *ä¸èƒ½é‡è½½*
      - =?:= æ¡ä»¶è¿ç®—ç¬¦
      - =sizeof= è¿ç®—ç¬¦
      - =::= ä½œç”¨åŸŸè§£æè¿ç®—ç¬¦
      - =.= æˆå‘˜é€‰æ‹©è¿ç®—ç¬¦
      - =.*= æŒ‡é’ˆæˆå‘˜é€‰æ‹©è¿ç®—ç¬¦
      - =typeid= è¿ç®—ç¬¦
      - =å¼ºåˆ¶ç±»å‹è½¬æ¢= è¿ç®—ç¬¦

5. *ä¸€äº›æ³¨æ„äº‹é¡¹*
   - operator++/-- :: [[https://www.learncpp.com/cpp-tutorial/overloading-the-increment-and-decrement-operators/][learncpp21.8]]
     a. å‰ç½®++/--ï¼šoperator++()
     b. åç½®++/--ï¼šoperator++(int) [fn:6]
   - operator[] :: [[https://www.learncpp.com/cpp-tutorial/overloading-the-subscript-operator/][learncpp21.9]]
     a. è¿”å›å¼•ç”¨ï¼ˆè¿™å°±ä»£è¡¨æˆ‘ä»¬ ğŸ”¥ *è¿”å›çš„æ˜¯å·¦å€¼* ï¼ï¼ï¼ï¼ï¼ï¼‰
     b. é‡è½½å¢åŠ  æ£€æµ‹ç´¢å¼•æœ‰æ•ˆæ€§ï¼ˆç”¨ assertï¼‰ é€»è¾‘[fn:7]
   - operator() :: é‡è½½ä»¥å®ç° [[id:077d1dca-3cdc-4702-bd47-67940bc06ae6][ä»¿å‡½æ•°]] [fn:8] [[https://www.learncpp.com/cpp-tutorial/overloading-the-parenthesis-operator/][learncpp21.10]]
   - operator= :: æ£€æµ‹å¹¶å¤„ç†è‡ªèµ‹å€¼ [fn:9] [[https://www.learncpp.com/cpp-tutorial/overloading-the-assignment-operator/][learncpp21.12]]
     + è‡ªèµ‹å€¼å­˜åœ¨çš„é—®é¢˜ :: èµ‹å€¼ï¼Œéœ€è¦åˆ é™¤åŸå¯¹è±¡ï¼Œå†å°†å¦ä¸€ä¸ªå¯¹è±¡èµ‹å€¼è¿‡æ¥ï¼Œå¦‚æœæ˜¯ *è‡ªèµ‹å€¼* ï¼Œä¼šå°†è‡ªå·±åˆ é™¤

6. [[id:12fb3f7f-a24f-4d01-a2e8-06d2469110fb][é‡è½½ç±»å‹è½¬åŒ–è¿ç®—ç¬¦]]ï¼šä¼˜å…ˆè¿˜æ˜¯é€‰æ‹© [[id:cf5f4669-1abc-45b6-9882-83008c96bd4a][è½¬æ¢æ„é€ å‡½æ•°]]

7. è¿ç®—ç¬¦é‡è½½ ä¸ *å‡½æ•°æ¨¡æ¿* [fn:10] [[https://www.learncpp.com/cpp-tutorial/overloading-operators-and-function-templates/][learncpp21.14]]
   æ¨¡æ¿å®ä¾‹åŒ–æ—¶ï¼Œç±»å‹æ›¿æ¢ï¼Œå¯èƒ½éœ€è¦å®ç°è¿ç®—ç¬¦é‡è½½ [fn:11]

8. *è¿”å›å€¼*
   1) å€¼è¿”å›          ï¼šä¸ä¿®æ”¹æ“ä½œæ•°çš„è¿ç®—ç¬¦
   2) å¼•ç”¨è¿”å›å·¦æ“ä½œæ•°ï¼šä¿®æ”¹å·¦æ“ä½œæ•°çš„è¿ç®—ç¬¦

* Footnotes

[fn:11]
#+begin_src cpp :results output :namespaces std :includes <iostream>
template <typename T>
T average(const T* myArray, int numValues)
{
    T sum { 0 };
    for (int count { 0 }; count < numValues; ++count)
        sum += myArray[count]; // NOTE æ¨¡æ¿å®ä¾‹åŒ–ï¼Œéœ€è¦å®ç° operator+=

    sum /= numValues;          // NOTE æ¨¡æ¿å®ä¾‹åŒ–ï¼Œéœ€è¦å®ç° operator/=
    return sum;
}

class Cents
{
private:
    int m_cents {};
public:
    Cents(int cents)
        : m_cents { cents }
    {
    }

    friend std::ostream& operator<< (std::ostream& out, const Cents& cents)
    {
        out << cents.m_cents << " cents ";
        return out;
    }

    Cents& operator+= (const Cents &cents)
    {
        m_cents += cents.m_cents;
        return *this;
    }

    Cents& operator/= (int x)
    {
        m_cents /= x;
        return *this;
    }
};

int main()
{
    Cents centsArray[] { Cents { 5 }, Cents { 10 }, Cents { 15 }, Cents { 14 } };
    // NOTE æ¨¡æ¿å®ä¾‹åŒ–ï¼Œéœ€è¦å®ç° operator<<
    std::cout << average(centsArray, 4) << '\n';

    return 0;
}
#+end_src

[fn:10]
#+begin_src cpp :results output :namespaces std :includes <iostream>
template <typename T>
T average(const T* myArray, int numValues)
{
    T sum { 0 };
    for (int count { 0 }; count < numValues; ++count)
        sum += myArray[count];

    sum /= numValues;
    return sum;
}

class Cents
{
private:
    int m_cents {};
public:
    Cents(int cents)
        : m_cents { cents }
    {
    }

    friend std::ostream& operator<< (std::ostream& out, const Cents& cents)
    {
        out << cents.m_cents << " cents ";
        return out;
    }

    Cents& operator+= (const Cents &cents)
    {
        m_cents += cents.m_cents;
        return *this;
    }

    Cents& operator/= (int x)
    {
        m_cents /= x;
        return *this;
    }
};

int main()
{
    Cents centsArray[] { Cents { 5 }, Cents { 10 }, Cents { 15 }, Cents { 14 } };
    std::cout << average(centsArray, 4) << '\n';

    return 0;
}
#+end_src


[fn:9]
#+begin_src cpp :results output :namespaces std :includes <iostream>
MyString& MyString::operator= (const MyString& str)
{
	// è‡ªèµ‹å€¼å¤„ç†ï¼šç›´æ¥è¿”å›
	if (this == &str)
		return *this;

	// åˆ é™¤è‡ªå·±çš„å€¼
	if (m_data) delete[] m_data;

	m_length = str.m_length;
	m_data = nullptr;

  // å¤åˆ¶ä»–äººçš„å€¼
	if (m_length)
		m_data = new char[static_cast<std::size_t>(str.m_length)];

	std::copy_n(str.m_data, m_length, m_data);

	// return the existing object so we can chain this operator
	return *this;
}
#+end_src

[fn:8]
#+begin_src cpp :results output :namespaces std :includes <iostream>
class Accumulator
{
private:
    int m_counter{ 0 };

public:
    int operator() (int i) { return (m_counter += i); }

    void reset() { m_counter = 0; } // optional
};

int main()
{
    Accumulator acc{};
    std::cout << acc(1) << '\n'; // prints 1
    std::cout << acc(3) << '\n'; // prints 4

    Accumulator acc2{};
    std::cout << acc2(10) << '\n'; // prints 10
    std::cout << acc2(20) << '\n'; // prints 30

    return 0;
}
#+end_src


[fn:7]
#+begin_src cpp :results output :namespaces std :includes <iostream>
#include <cassert> // for assert()
#include <iterator> // for std::size()

class IntList
{
private:
    int m_list[10]{};

public:
    int& operator[] (int index)
    {
        // operator[] æ˜¯ä¸ä¼šè¿›è¡Œè¾¹ç•Œæ£€æŸ¥çš„ï¼Œæˆ‘ä»¬é‡è½½åå¯ä»¥åŠ å…¥ ç´¢å¼•æ£€æŸ¥æœ‰æ•ˆæ€§
        assert(index >= 0 && static_cast<std::size_t>(index) < std::size(m_list));

        return m_list[index];
    }
};

int main() {
  IntList list{};         // IntList *list{}; åˆ™ä¸èƒ½ä½¿ç”¨ list[2] -> æ”¹ä¸ºï¼š(*list)[2]
  cout << list[2] << '\n';
}
#+end_src

[fn:6]
#+begin_src cpp :results output :namespaces std :includes <iostream>
class Digit
{
private:
    int m_digit{};
public:
    Digit(int digit=0) : m_digit{digit} { }
    // å‰ç½®ï¼šæ— å‚æ•°
    Digit& operator++();
    Digit& operator--();
    // åç½®ï¼šint å‚æ•°
    Digit operator++(int);
    Digit operator--(int);

    friend std::ostream& operator<< (std::ostream& out, const Digit& d);
};

Digit& Digit::operator++()
{
    if (m_digit == 9)
        m_digit = 0;
    else
        ++m_digit;

    return *this;
}

Digit& Digit::operator--()
{
    if (m_digit == 0)
        m_digit = 9;
    else
        --m_digit;

    return *this;
}

// NOTE åç½®å®ç°æ–¹å¼
Digit Digit::operator++(int)
{
    Digit temp{*this};

    ++(*this); // è°ƒç”¨ å‰ç½®++

    // è¿”å›ä¸´æ—¶å¯¹è±¡
    return temp;
}

Digit Digit::operator--(int)
{
    Digit temp{*this};

    --(*this);

    return temp;
}

std::ostream& operator<< (std::ostream& out, const Digit& d)
{
	out << d.m_digit;
	return out;
}

int main()
{
    Digit digit { 5 };

    std::cout << digit;
    std::cout << ++digit; // calls Digit::operator++();
    std::cout << digit++; // calls Digit::operator++(int);
    std::cout << digit;
    std::cout << --digit; // calls Digit::operator--();
    std::cout << digit--; // calls Digit::operator--(int);
    std::cout << digit;

    return 0;
}
#+end_src


[fn:5]
#+begin_src cpp :results output :namespaces std :includes <iostream>
class Point
{
private:
    double m_x{};
    double m_y{};
    double m_z{};

public:
    Point(double x=0.0, double y=0.0, double z=0.0)
      : m_x{x}, m_y{y}, m_z{z}
    {
    }

    friend std::ostream& operator<< (std::ostream& out, const Point& point);
};

std::ostream& operator<< (std::ostream& out, const Point& point)
{
    out << "Point(" << point.m_x << ", " << point.m_y << ", " << point.m_z << ')';
    return out; // è¿”å› std::ostream æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é“¾å¼è°ƒç”¨
}

int main()
{
    const Point point1 { 2.0, 3.0, 4.0 };

    std::cout << point1 << '\n';

    return 0;
}
#+end_src

[fn:4]
#+begin_src cpp :results output :namespaces std :includes <iostream>
class Cents
{
private:
    int m_cents {};

public:
    Cents(int cents) : m_cents { cents } { }

    // æˆå‘˜å‡½æ•°é‡è½½ï¼šCents + int
    Cents operator+(int value) const;

    int getCents() const { return m_cents; }
};

// å·¦æ“ä½œæ•° æ˜¯ éšå¼çš„*this
Cents Cents::operator+ (int value) const
{
    return Cents { m_cents + value };
}

int main()
{
	const Cents cents1 { 6 };
	const Cents cents2 { cents1 + 2 };
	std::cout << "I have " << cents2.getCents() << " cents.\n";

	return 0;
}
#+end_src

[fn:3]
#+name: Cents.h
#+begin_src cpp :results output :namespaces std :includes <iostream>
#ifndef CENTS_H
#define CENTS_H

class Cents
{
private:
  int m_cents{};
public:
  Cents(int cents) : m_cents{ cents } { }

  int getCents() const { return m_cents; }
};
// æä¾›å‡½æ•°å£°æ˜
Cents operator+(const Cents& c1, const Cents& c2);

#endif
#+end_src

#+name: Cents.cpp
#+begin_src cpp :results output :namespaces std :includes <iostream>
#include "Cents.h"

Cents operator+(const Cents& c1, const Cents& c2)
{
  return { c1.getCents() + c2.getCents() };
}
#+end_src

#+name: main.cpp
#+begin_src cpp :results output :namespaces std :includes <iostream>
#include "Cents.h"

int main()
{
  Cents cents1{ 6 };
  Cents cents2{ 8 };
  Cents centsSum{ cents1 + cents2 }; // æ²¡æœ‰ Cents.h ä¸­çš„å‡½æ•°å£°æ˜, è¿™ä¸ªä¼šç¼–è¯‘é”™è¯¯
  std::cout << "I have " << centsSum.getCents() << " cents.\n";

  return 0;
}
#+end_src

[fn:2]
#+begin_src cpp :results output :namespaces std :includes <iostream>
class Cents
{
private:
  int m_cents{};

public:
  Cents(int cents) : m_cents{ cents } { }

  int getCents() const { return m_cents; }
};

// æ™®é€šå‡½æ•°ï¼šä½¿ç”¨ç±»æä¾›çš„å…¬å…±æ¥å£è®¿é—®ç§æœ‰æˆå‘˜
Cents operator+(const Cents& c1, const Cents& c2)
{
  return Cents{ c1.getCents() + c2.getCents() };
}

int main()
{
  Cents cents1{ 6 };
  Cents cents2{ 8 };
  Cents centsSum{ cents1 + cents2 };
  std::cout << "I have " << centsSum.getCents() << " cents.\n";

  return 0;
}
#+end_src

#+RESULTS:
: I have 14 cents.


[fn:1]
#+begin_src cpp :results output :namespaces std :includes <iostream>
class Cents
{
private:
	int m_cents {};
public:
  Cents(int cents) : m_cents{ cents } { }

	friend Cents operator+(const Cents& c1, const Cents& c2); // NOTE å‹å…ƒå‡½æ•°ï¼šç±»å¤–å®ç° Cents + Cents

	int getCents() const { return m_cents; }

  // NOTE å‹å…ƒå‡½æ•°ï¼šç±»å†…å®ç° -> ç±»å†…å®ç°ä¹Ÿå±äº ç±»çš„æˆå‘˜
  // friend Cents operator+(const Cents& c1, const Cents& c2)
	// {
	//    return Cents { c1.m_cents + c2.m_cents };
	// }

};

// å‹å…ƒå‡½æ•°ï¼šç±»å¤–å®ç°
Cents operator+(const Cents& c1, const Cents& c2)
{
	return c1.m_cents + c2.m_cents; // å› ä¸ºæ˜¯å‹å…ƒå‡½æ•°ï¼Œå› æ­¤å¯ä»¥è®¿é—®ç±»ç§æœ‰å˜é‡
}

int main()
{
	Cents cents1{ 6 };
	Cents cents2{ 8 };
	Cents centsSum{ cents1 + cents2 };
	std::cout << "I have " << centsSum.getCents() << " cents.\n";

	return 0;
}
#+end_src

#+RESULTS:
: I have 14 cents.
