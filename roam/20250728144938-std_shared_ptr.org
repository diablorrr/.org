:PROPERTIES:
:ID:       40c9dfcd-6bcb-4bec-8160-89b3187c4997
:END:
#+title: std::shared_ptr
#+filetags: cpp

* std::shared_ptr [[https://www.learncpp.com/cpp-tutorial/stdshared_ptr/][learncpp22.6]]
1. cpp11ï¼Œ *å…±äº«èµ„æº* çš„æ™ºèƒ½æŒ‡é’ˆ
   - å†…éƒ¨ ::
     1) æŒ‡é’ˆæŒ‡å‘ èµ„æº
     2) æŒ‡é’ˆæŒ‡å‘ *æ§åˆ¶å—* ï¼ˆå†…éƒ¨æœ‰ *å¼•ç”¨è®¡æ•°* ï¼šè¡¨ç¤ºæœ‰å¤šå°‘ä¸ª å…±äº«æŒ‡é’ˆ æŒ‡å‘èµ„æºï¼›å¼•ç”¨è®¡æ•°å½’ 0 æ—¶ï¼Œæ‰é‡Šæ”¾æŒ‡é’ˆï¼‰
        ğŸ”¥ å¸¸è§é”™è¯¯ï¼šæŸä¸ªèµ„æºè¢« std::shared_ptr ç®¡ç†ï¼Œå¦ä¸€ä¸ª std::shared_ptr ä¸ä½¿ç”¨æ‹·è´çš„æ–¹å¼ä¸€èµ·ç®¡ç†èµ„æºï¼Œè€Œæ˜¯ä½¿ç”¨èµ„æºç›´æ¥åˆå§‹åŒ– -> å¯¼è‡´ä¸¤ä¸ªæŒ‡é’ˆæœ‰å„è‡ªçš„ æ§åˆ¶å—ï¼Œå¼•ç”¨è®¡æ•°ä¸åŒæ­¥
   #+name: æ‹·è´åˆå§‹åŒ–
   #+begin_src cpp :results output :namespaces std :includes <iostream> <memory>
   class Resource
   {
   public:
     Resource() { std::cout << "Resource acquired\n"; }
     ~Resource() { std::cout << "Resource destroyed\n"; }
   };

   int main()
   {
     Resource* res { new Resource };
     std::shared_ptr<Resource> ptr1{ res };     // ç›´æ¥åˆå§‹åŒ– ptr1 ï¼ˆç”¨èµ„æºç›´æ¥åˆå§‹åŒ–ï¼‰
     {
       std::shared_ptr<Resource> ptr2 { ptr1 }; // æ‹·è´åˆå§‹åŒ– ptr2 ï¼ˆå¤åˆ¶çš„å½¢å¼åˆå§‹åŒ–ï¼‰
       std::cout << "Killing one shared pointer\n";
     } // ptr2 è¶…å‡ºä½œç”¨åŸŸ
     std::cout << "Killing another shared pointer\n";
     return 0;
   } // ptr1è¶…å‡ºä½œç”¨åŸŸ
   #+end_src

   #+name: ç›´æ¥åˆå§‹åŒ–
   #+begin_src cpp :results output :namespaces std :includes <iostream> <memory>
   class Resource
   {
   public:
     Resource() { std::cout << "Resource acquired\n"; }
     ~Resource() { std::cout << "Resource destroyed\n"; }
   };

   int main()
   {
    Resource* res { new Resource };
    std::shared_ptr<Resource> ptr1 { res };   // ç›´æ¥åˆå§‹åŒ– ptr1ï¼ˆä»èµ„æºåˆå§‹åŒ–ï¼‰
    {
      std::shared_ptr<Resource> ptr2 { res }; // FIXME ç›´æ¥åˆå§‹åŒ– ptr2ï¼ˆä»èµ„æºåˆå§‹åŒ–ï¼‰
      std::cout << "Killing one shared pointer\n";
    } // ptr2 è¶…å‡ºä½œç”¨åŸŸ
    std::cout << "Killing another shared pointer\n";
    return 0;
   } // ptr1 è¶…å‡ºä½œç”¨åŸŸ
   #+end_src

2. å¯ä»¥ç”¨ =std::make_shared()= åˆå§‹åŒ–æ™ºèƒ½æŒ‡é’ˆï¼Œç®€å•å®‰å…¨

3. åˆ›å»ºè¿”å›æ™ºèƒ½æŒ‡é’ˆçš„å‡½æ•°ï¼Œé€‰æ‹© *è¿”å› std::unique_ptr* ï¼Œå› ä¸º
   - å¯ä»¥ [[id:02ce83ed-31b4-4906-89e4-271bbf432834][std::unique_ptr]]  --è½¬æ¢-->  std::shared_ptr
   - ä¸èƒ½ std::shared_ptr  --è½¬æ¢-->  std::unique_ptr

4. *å¾ªç¯å¼•ç”¨* é—®é¢˜ï¼šä¸¤ä¸ªå¯¹è±¡å†…éƒ¨çš„ std::shared_ptr äº’ç›¸æŒ‡å‘å¯¹è±¡ -> å¼•ç”¨è®¡æ•°æ— æ³•å½’ 0ï¼Œå†…å­˜æ³„æ¼ [[https://www.learncpp.com/cpp-tutorial/circular-dependency-issues-with-stdshared_ptr-and-stdweak_ptr/][learncpp22.7]]
   ï¼ˆä»¥ä¸Šæ˜¯ a -> bã€b -> aï¼›ä¹Ÿèƒ½æ˜¯ä¸‰ä¸ªå¯¹è±¡ï¼ša -> bã€b -> cã€c -> aï¼‰
   #+begin_src cpp :results output :namespaces std :includes <iostream> <memory> <string>
   class Person
   {
     std::string m_name;
     std::shared_ptr<Person> m_partner; // æŒ‡å‘ Person çš„æŒ‡é’ˆ
   public:
     Person(const std::string &name): m_name(name) { std::cout << m_name << " created\n"; }
     ~Person() { std::cout << m_name << " destroyed\n"; }

     friend bool partnerUp(std::shared_ptr<Person> &p1, std::shared_ptr<Person> &p2)
     {
       if (!p1 || !p2)
         return false;
       p1->m_partner = p2; // p1 å†…éƒ¨çš„å…±äº«æŒ‡é’ˆæŒ‡å‘ p2
       p2->m_partner = p1; // p2 å†…éƒ¨çš„å…±äº«æŒ‡é’ˆæŒ‡å‘ p1
       std::cout << p1->m_name << " is now partnered with " << p2->m_name << '\n';
       return true;
     }
   };
   int main()
   {
     auto lucy { std::make_shared<Person>("Lucy") };  // lucy æŒ‡å‘ Personç±»ï¼ˆLucyï¼‰
     auto ricky { std::make_shared<Person>("Ricky") }; // lucy æŒ‡å‘ Personç±»ï¼ˆRickyï¼‰
     partnerUp(lucy, ricky); // Lucy å’Œ Ricky äº’æŒ‡
                             // Lucy è¢«ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘ï¼šlucyã€Ricky å†…éƒ¨çš„ m_partnerï¼›RickyåŒç†è¢«ä¸¤ä¸ªæŒ‡é’ˆæŒ‡
     return 0;
   } // æ­¤æ—¶é‡Šæ”¾äº†ä¸¤ä¸ªæŒ‡é’ˆï¼šlucyã€rickyï¼›ä½† Lucy å’Œ Ricky è¿˜è¢«æŒ‡é’ˆæŒ‡å‘ï¼ˆRickyã€Lucy å†…éƒ¨çš„ m_partnerï¼‰ï¼Œå› æ­¤éƒ½ä¸ä¼šé‡Šæ”¾
   #+end_src

   *è§£å†³æ–¹æ¡ˆ* ï¼š[[id:eb06d6f0-46b3-4793-836e-6bd8e3a4814e][std::weak_ptr]]ï¼ˆè‹¥æ˜¯ä¸¤ä¸ªä¸åŒçš„ç±»å¯¹è±¡äº’ç›¸æŒ‡å‘ï¼Œåˆ™è¿˜éœ€è¦ [[id:98b78b88-32ba-4ad7-b5d5-efeae3da8405][å‰ç½®å£°æ˜]]ï¼‰
   #+begin_src cpp :results output :namespaces std :includes <iostream> <memory> <string>
   class Person
   {
     std::string m_name;
     std::weak_ptr<Person> m_partner; // å†…éƒ¨æ”¹ä¸º std::weak_ptr
   public:

     Person(const std::string &name): m_name(name) { std::cout << m_name << " created\n"; }
     ~Person() { std::cout << m_name << " destroyed\n"; }

     friend bool partnerUp(std::shared_ptr<Person> &p1, std::shared_ptr<Person> &p2)
     {
       if (!p1 || !p2)
         return false;
       p1->m_partner = p2; // std::weak_ptr æ˜¯è§‚å¯Ÿè€…ï¼Œä¸æ˜¯æ‰€æœ‰è€…ï¼Œå› æ­¤ä¸ä¼šå¢åŠ  å¼•ç”¨è®¡æ•°
       p2->m_partner = p1;
       std::cout << p1->m_name << " is now partnered with " << p2->m_name << '\n';
       return true;
     }
   };

   int main()
   {
     auto lucy { std::make_shared<Person>("Lucy") };
     auto ricky { std::make_shared<Person>("Ricky") };
     partnerUp(lucy, ricky);
     return 0;
   } // Lucyã€Ricky æ­£å¸¸é”€æ¯
   #+end_src
