:PROPERTIES:
:ID:       40c9dfcd-6bcb-4bec-8160-89b3187c4997
:END:
#+title: std::shared_ptr
#+filetags: cpp

* std::shared_ptr [[https://www.learncpp.com/cpp-tutorial/stdshared_ptr/][learncpp22.6]]
1. cpp11ï¼Œ *å…±äº«èµ„æº* çš„æ™ºèƒ½æŒ‡é’ˆï¼Œå¤šä¸ªæŒ‡é’ˆå…±åŒç®¡ç†èµ„æº
   - å†…éƒ¨ ::
     1) æŒ‡é’ˆæŒ‡å‘ èµ„æº
     2) æŒ‡é’ˆæŒ‡å‘ *æ§åˆ¶å—* ï¼šæ§åˆ¶å—å†…éƒ¨æœ‰
        - å¼ºå¼•ç”¨è®¡æ•°ï¼ˆ =use_count= ï¼‰ ï¼šè¡¨ç¤ºç®¡ç†èµ„æºçš„å…±äº«æŒ‡é’ˆæ•°é‡ï¼Œç®¡ç†èµ„æºç”Ÿå‘½å‘¨æœŸï¼›
          æ¯å¢åŠ ä¸€ä¸ªå…±äº«æŒ‡é’ˆç®¡ç†èµ„æºï¼šuse_count+1ï¼›æ¯å‡å°‘ï¼šuse_count-1ï¼›use_count=0 æ—¶ï¼Œé”€æ¯èµ„æº
        - å¼±å¼•ç”¨è®¡æ•°ï¼ˆ =weak_count= ï¼‰ï¼šè¡¨ç¤ºè§‚å¯Ÿèµ„æºçš„ [[id:eb06d6f0-46b3-4793-836e-6bd8e3a4814e][std::weak_ptr]] æ•°é‡ï¼Œç®¡ç†æ§åˆ¶å—ç”Ÿå‘½å‘¨æœŸï¼›
          æ¯å¢åŠ ä¸€ä¸ªå¼±æŒ‡é’ˆè§‚å¯Ÿèµ„æºï¼šweak_count+1ï¼›æ¯å‡å°‘ï¼šweak_count-1ï¼›å½“ use_count=0æ—¶ï¼šweak_count-1ï¼›weak_count=0 æ—¶ï¼Œé”€æ¯æ§åˆ¶å—
        #+begin_comment æ§åˆ¶å—ç¤ºä¾‹
        *åœºæ™¯1*
        sharedæŒ‡é’ˆAæŒ‡å‘èµ„æºRï¼šæ§åˆ¶å—use_count=1ã€weak_count=1
        sharedæŒ‡é’ˆBæŒ‡å‘R    ï¼šuse_count=2ã€weak_count=1
        é”€æ¯B               ï¼šuse_count=1ã€weak_count=1
        é”€æ¯A               ï¼šuse_count=0ã€weak_count=0

        *åœºæ™¯2*
        sharedæŒ‡é’ˆAæŒ‡å‘èµ„æºRï¼šæ§åˆ¶å—use_count=1ã€weak_count=1
        sharedæŒ‡é’ˆBæŒ‡å‘R    ï¼šuse_count=2ã€weak_count=1
        weakæŒ‡é’ˆWæŒ‡å‘R      ï¼šuse_count=2ã€weak_count=2
        é”€æ¯B               ï¼šuse_count=1ã€weak_count=2
        é”€æ¯A               ï¼šuse_count=0ã€weak_count=1
        #+end_comment

2. ğŸ”¥ å¸¸è§é”™è¯¯ï¼šæŸä¸ªèµ„æºè¢« std::shared_ptr ç®¡ç†ï¼Œå¦ä¸€ä¸ª std::shared_ptr ä¸ä½¿ç”¨æ‹·è´çš„æ–¹å¼ä¸€èµ·ç®¡ç†èµ„æºï¼Œè€Œæ˜¯ä½¿ç”¨èµ„æºç›´æ¥åˆå§‹åŒ– -> å¯¼è‡´ä¸¤ä¸ªæŒ‡é’ˆæœ‰å„è‡ªçš„ æ§åˆ¶å—ï¼Œå¼•ç”¨è®¡æ•°ä¸åŒæ­¥ [fn:1]

3. *å¾ªç¯å¼•ç”¨* é—®é¢˜ï¼šè§ [[id:eb06d6f0-46b3-4793-836e-6bd8e3a4814e][std::weak_ptr]]

4. å¯ä»¥ç”¨ =std::make_shared()= åˆå§‹åŒ–æ™ºèƒ½æŒ‡é’ˆï¼Œç®€å•å®‰å…¨

5. åˆ›å»ºè¿”å›æ™ºèƒ½æŒ‡é’ˆçš„å‡½æ•°ï¼Œé€‰æ‹© *è¿”å› std::unique_ptr* ï¼Œå› ä¸º
   - å¯ä»¥ [[id:02ce83ed-31b4-4906-89e4-271bbf432834][std::unique_ptr]]  --è½¬æ¢-->  std::shared_ptr
   - ä¸èƒ½ std::shared_ptr  --è½¬æ¢-->  std::unique_ptr


* Footnotes

[fn:1]
#+name: ä»èµ„æºåˆå§‹åŒ–shareæŒ‡é’ˆ
#+begin_src cpp :results output :namespaces std :includes <iostream> <memory>
class Resource
{
public:
  Resource() { std::cout << "Resource acquired\n"; }
  ~Resource() { std::cout << "Resource destroyed\n"; }
};

int main()
{
 Resource* res { new Resource };
 std::shared_ptr<Resource> ptr1 { res };   // ç›´æ¥åˆå§‹åŒ– ptr1ï¼ˆä»èµ„æºåˆå§‹åŒ–ï¼‰
 {
   std::shared_ptr<Resource> ptr2 { res }; // FIXME ç›´æ¥åˆå§‹åŒ– ptr2ï¼ˆä»èµ„æºåˆå§‹åŒ–ï¼‰
   std::cout << "Killing one shared pointer\n";
 } // ptr2 è¶…å‡ºä½œç”¨åŸŸ
 std::cout << "Killing another shared pointer\n";
 return 0;
} // ptr1 è¶…å‡ºä½œç”¨åŸŸ
#+end_src

#+name: æ­£ç¡®åšæ³•
#+begin_src cpp :results output :namespaces std :includes <iostream> <memory>
class Resource
{
public:
  Resource() { std::cout << "Resource acquired\n"; }
  ~Resource() { std::cout << "Resource destroyed\n"; }
};

int main()
{
  Resource* res { new Resource };
  std::shared_ptr<Resource> ptr1{ res };     // ç›´æ¥åˆå§‹åŒ– ptr1 ï¼ˆç”¨èµ„æºç›´æ¥åˆå§‹åŒ–ï¼‰
  {
    std::shared_ptr<Resource> ptr2 { ptr1 }; // æ‹·è´åˆå§‹åŒ– ptr2 ï¼ˆå¤åˆ¶çš„å½¢å¼åˆå§‹åŒ–ï¼‰
    std::cout << "Killing one shared pointer\n";
  } // ptr2 è¶…å‡ºä½œç”¨åŸŸ
  std::cout << "Killing another shared pointer\n";
  return 0;
} // ptr1è¶…å‡ºä½œç”¨åŸŸ
#+end_src
